name: Publish
#  on:
#    push:
#      branches:
#        - main

jobs:
  deploy_artifactory:
    name: Deploy to Artifactory:
    runs-on: ubuntu-latest
    steps:
         - uses: actions/checkout@v2

         - name: Set ud JDK 17
           uses: actions/setup-java@v3
           with:
            java-version: 17

         - name: build with Maven
           run: mvn clean install

         - name: Publish to Artifactory
           run: mvn -s ./jparest_settings.xml -f pom.xml install -B org.apache.maven.plugins:maven-deploy-plugin:2.8.2:deploy -DskipTests
           env:
            registry: https://artifactory.digital.homeoffice.gov.uk/artifactory/callisto-jparest
            ARTIFACTORY_TOKEN: "${{ secrets.ARTIFACTORY_TOKEN }}"

name: Snapshot
  on:
      branches:
        - '!main'

jobs:
  deploy_snapshot:
    name: Deploy Snapshot:
    runs-on: ubuntu-latest
    steps:
         - uses: actions/checkout@v2

         - name: Set ud JDK 17
           uses: actions/setup-java@v3
           with:
            java-version: 17

         - name: build with Maven
           run: mvn clean install

         - name: Publish to Artifactory
           run: |
            "BRANCH=$(echo $DRONE_BRANCH | tr '[:lower:]' '[:upper:]') && [[ $BRANCH =~ (EAHW-[0-9]*) ]] && snapshotSuffix=$${match/#E/-E}$${BASH_REMATCH/#E/-E}"
            mvn -s ./jparest_settings.xml -f pom.xml install -B org.apache.maven.plugins:maven-deploy-plugin:2.8.2:deploy -DsnapshotSuffix=$${snapshotSuffix}-SNAPSHOT -DskipTests

